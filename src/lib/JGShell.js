!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("lodash"),require("rete")):"function"==typeof define&&define.amd?define(["lodash","rete"],e):"object"==typeof exports?exports.JGShell=e(require("lodash"),require("rete")):t.JGShell=e(t._,t.rete)}(this,function(t,e){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=17)}([function(e,n){e.exports=t},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.GraphNode=void 0;var o=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),s=n(0),a=r(s),u=(n(2),n(7)),c=1,h=function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;i(this,t),e=e||"anon",this.id=r||c++,r&&r>c&&(c=r+1),this._edges=new Map,this._values=new Map,this._tags=new Set,this.minimised=!1,this.tag("graphnode"),this.setValue("name",e),n===-1&&(n=this.id),void 0!==n&&null!==n&&(this.setEdge(n,{id:n},{},{id:this.id}),this.setValue("_parentId",n))};h.fromJSON=function(t){var e=new h(null,null,t.id),n=!0,r=!1,i=void 0;try{for(var s,a=t.edges[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var c=s.value,l=o(c,2),f=(l[0],l[1]),d=u.Edge.fromJSON(f),p=null;p=d.source.id===t.id?f.dest.id:f.source.id,e._edges.set(p,d)}}catch(t){r=!0,i=t}finally{try{!n&&a.return&&a.return()}finally{if(r)throw i}}return e._values=new Map(t.values),e._tags=new Set(t.tags),e},h.prototype.getParents=function(){var t=this;return a.default.filter(Array.from(this._edges.values()),function(e){return e.dest.id===t.id})},h.prototype.getChildren=function(){var t=this;return a.default.filter(Array.from(this._edges.values()),function(e){return e.source.id===t.id})},h.prototype.toJSONCompatibleObj=function(){return{id:this.id,edges:Array.from(this._edges),values:Array.from(this._values),tags:Array.from(this._tags)}},h.prototype.toString=function(){return"("+this.id+") : "+this.name._slice(0,10)},h.prototype.setEdge=function(t,e,n,r){if(t instanceof h&&(t=t.id),null===e.id?e.id=this.id:null===r.id&&(r.id=this.id),t!==e.id&&t!==r.id)throw console.log("Inconsistent Edge data:",e,r),new Error("Specified an id for an edge that is inconsistent");if(this.id!==e.id&&this.id!==r.id)throw console.log("Unconnected Target node:".sourceData,r),new Error("Specified an edge unconnected to the targeted node");var i=new u.Edge(e,n,r);return this._edges.set(t,i),this},h.prototype.getEdgeTo=function(t){if(t instanceof h&&(t=t.id),!this.hasEdgeWith(t))throw new Error("Node does not have specified edge");return this._edges.get(t)},h.prototype.removeEdge=function(t){if(t instanceof h&&(t=t.id),!this.hasEdgeWith(t))throw new Error("Can't remove an edge that doesn't exist");return this._edges.delete(t),this},h.prototype.numOfEdges=function(){return this._edges.size},h.prototype.hasEdgeWith=function(t){return t instanceof h&&(t=t.id),!!this._edges.has(t)},h.prototype.name=function(){return this.getValue("name")},h.prototype.setName=function(t){return this.setValue("name",t),this},h.prototype.setValue=function(t,e){return void 0!==e?this._values.set(t,e):this._values.delete(t),this},h.prototype.getValue=function(t){if(!this._values.has(t))throw new Error("Can't get a value for a non-existent key");return this._values.get(t)},h.prototype.values=function(){return Array.from(this._values)},h.prototype.tags=function(){return Array.from(this._tags)},h.prototype.hasTag=function(t){return this._tags.has(t)},h.prototype.tag=function(t){return this._tags.add(t),this},h.prototype.tagToggle=function(t){return this.hasTag(t)?this.untag(t):this._tags.add(t),this},h.prototype.untag=function(t){return this._tags.delete(t),this},e.GraphNode=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.util=void 0;var i=n(0),o=(r(i),{});o.operatorToString=function(t){var e={EQ:"==",LT:"<",GT:">",LTE:"<=",GTE:">=",NE:"!=="};return e[t]?e[t]:(console.warn("No conversion for operator:",t),t)},o.annotate=function(t,e,n,r,i,o,s,a,u,c){t.exit().remove();var h=t.enter().append("g").classed(e,!0);return h.append("rect").classed(e+"rect",!0),h.append("text").classed(e+"text",!0).attr("dy","1.4em"),t.attr("transform",function(t,e){return"translate("+o+","+(n+e*(r+i))+")"}),t.selectAll("."+e+"rect").attr("width",s-2*o).attr("height",r).style("fill",a).attr("rx",10).attr("ry",10),t.selectAll("."+e+"text").attr("transform","translate("+o+","+.2*r+")").text(u).style("fill",c||"white")},o.truncateDrawnText=function(t){for(var e=this.getBBox(),n=t.name.length-4;e.wdith>10&&n>10;)t.shortName=t.name.slice(0,n)+"...",e=this.getBBox(),n-=2},e.util=o},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function t(e){r(this,t),this.id=e},o=function t(){r(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this.ids=n},s=function t(){r(this,t);for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];this.names=n},a=function t(e,n){r(this,t),this.sourceId=e,this.destId=n},u=function t(e){r(this,t),this.tagNames=e},c=function t(e,n){r(this,t),this.valName=e,this.value=n},h=function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,t),this.type=e,this.variable=n,this.value=i},l=function t(e,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r(this,t),this.type=e,this.variable=n,this.value=i},f=function t(e){r(this,t),this.command=e},d=function t(e){r(this,t),this.text=e},p=function t(e){r(this,t),this.name=e};e.Cd=i,e.Rm=o,e.Mk=s,e.Link=a,e.SetTag=u,e.SetValue=c,e.Search=h,e.Refine=l,e.Apply=f,e.Unparameterised=p,e.Import=d},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.getCtor=void 0;var i=n(0),o=(r(i),n(1)),s=n(14),a=n(10),u=n(8),c=n(13),h=n(9),l=n(15),f=n(12),d=n(11),p=new Map([["graphnode",o.GraphNode],["rule",s.Rule],["condition",a.Condition],["action",u.Action],["institution",c.Institution],["bookmark",h.Bookmark],["state",l.State],["event",d.Event],["fsm",f.FSM]]),g=function(t){return void 0!==t&&p.has(t.toLowerCase())?p.get(t.toLowerCase()):p.get("graphnode")};e.getCtor=g},function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}Object.defineProperty(e,"__esModule",{value:!0}),e.parser=void 0;var o=n(16),s=r(o),a=n(3),u=r(a),c=function(t){return s.optWhitespace.then(t).skip(s.optWhitespace)},h=function(t){return t.skip(s.whitespace)},l="unstash stash root cwd help export prior clear select",f=s.alt.apply(s,i(l.split(" ").map(function(t){return s.string(t)}))),d=f.map(function(t){return new u.Unparameterised(t)}),p=s.string("#"),g=s.string("$"),y=h(s.string(":")),m=s.string(">"),v=s.string("@"),w=s.string("<"),_=h(s.alt(s.string("cd"),v)),b=h(s.string("mk")),x=h(s.string("link")),k=h(s.string("rm")),E=h(s.string("set")),S=h(s.alt(s.string("tag"),p)),O=h(s.alt(s.string("value"),g)),N=h(s.string("search")),T=h(s.string("refine")),A=h(s.string("apply")),M=h(s.string("import")),j=c(s.regex(/[a-zA-Z][a-zA-Z0-9_$]*/)),I=s.string('"').then(s.regex(/[a-zA-Z0-9\- '$%{}&;:.]+/)).skip(s.string('"')),R=c(s.regex(/[0-9]+/).map(Number)),C=c(s.string("..")),P=s.regex(/-?[0-9]+(\.[0-9]+)?/).map(Number),G=s.alt(j,I,P).skip(s.optWhitespace),B=s.string("/"),U=s.regex(/[ .a-zA-Z'"0-9-+=_!@#$%^&*()\[\]|]+/),D=s.regex(/[gimuy]*/),L=B.then(s.seqMap(U.skip(B),D.skip(B),function(t,e){return RegExp(t,e)})).skip(s.optWhitespace),q=_.then(s.alt(R,C,j)).map(function(t){return new u.Cd(t)}),V=b.then(j.many()).map(function(t){return new(Function.prototype.bind.apply(u.Mk,[null].concat(i(t))))}),F=x.then(s.seqMap(R,R,function(t,e){return new u.Link(t,e)})),z=k.then(R.many()).map(function(t){return new(Function.prototype.bind.apply(u.Rm,[null].concat(i(t))))}),J=E.then(S).then(j.many()).map(function(t){return new u.SetTag(t)}),W=E.then(O).then(s.seqMap(j,G,function(t,e){return new u.SetValue(t,e)})),$=M.then(s.all).map(function(t){return new u.Import(t)}),Z=p.then(j).map(function(t){return new u.SetTag([t])}),K=g.then(s.seqMap(j.skip(y),G,function(t,e){return new u.SetValue(t,e)})),H=s.seqMap(R.skip(m),R,function(t,e){return new u.Link(t,e)}),Q=v.then(s.alt(R,C,j)).map(function(t){return new u.Cd(t)}),X=w.then(s.eof).map(function(){return new u.Unparameterised("prior")}),Y=N.then(s.seqMap(j,L,function(t,e){return new u.Search(t,e)})),tt=N.then(s.seqMap(j,s.alt(j,L),s.alt(R,L),function(t,e,n){return new u.Search(t,e,n)})),et=T.then(s.seqMap(j,L,function(t,e){return new u.Refine(t,e)})),nt=T.then(s.seqMap(j,L,L,function(t,e,n){return new u.Refine(t,e,n)})),rt=s.alt(V,F,z,J,W,tt,Y,nt,et),it=s.alt(Z,K,H,Q,X),ot=A.then(s.alt(it,rt)).map(function(t){return new u.Apply(t)}),st=s.alt(ot,it,q,$,d,rt);e.parser=st},function(t,n){t.exports=e},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var i=function t(e,n,i){if(r(this,t),this.source=e,this.edge=n,this.dest=i,!("id"in this.source&&"id"in this.dest))throw new Error("Edges must have ids")};i.fromJSON=function(t){return new i(t.source,t.edge,t.dest)},i.prototype.connectedTo=function(t){return this.source.id===t||this.dest.id===t},i.prototype.idMatches=function(t,e){if(/dest/.test(e))return this.idMatchesDestination(t);if(/source/.test(e))return this.idMatchesSource(t);throw new Error("IdMatches was passed an unexpected edge type: "+e)},i.prototype.idMatchesSource=function(t){return this.source.id===t},i.prototype.idMatchesDestination=function(t){return this.dest.id===t},e.Edge=i},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Action=void 0;var i=n(0),o=r(i),s=n(1),a=function(t,e,n,r,i){for(s.GraphNode.call(this,t,e,"action",{},i),this.tags.actionType=n||"assert";r&&r.length>=2;)this.values[r.shift()]=r.shift();this.arithmeticActions={},this.regexActions={},this.timing={invalidateOffset:0,performOffset:0,unperformOffset:0},this.priority=0};a.prototype=Object.create(s.GraphNode.prototype),a.constructor=a,a.prototype.setArith=function(t,e,n){if(arguments.length<1)throw new Error("setArith needs at least a value");3!==arguments.length?delete this.arithmeticActions[t]:this.arithmeticActions[t]=[e,n]};var u=/\/(.+)\/(.+)\/(.*)/;a.prototype.setRegex=function(t,e){if(void 0===e)delete this.regexActions[t];else{var n=e.match(u);if(null===n||4!==n.length)throw new Error("Invalid regex");this.regexActions[t]=[n[1],n[3],n[2]]}},a.prototype.setTiming=function(t,e){void 0!==this.timing[t]&&(this.timing[t]=Number(e))},a.prototype.setPriority=function(t){if(isNaN(t))throw new Error("Priority must be a number");this.priority=t},a.prototype.getDescriptionObjects=function(t){var e=this;if(this.minimised)return[{name:this.toString()+"...",background:"title"}];var n=void 0!==t?[]:["Values","Source For:","Sink For:"],r=o.default.reject(this.getDescriptionObjectsBase(),function(t){return n.indexOf(t.name)!==-1});r.push({name:"Data",values:o.default.toPairs(this.values).map(function(t){return t.join(" : ")}),background:"data"}),r.push({name:"Arithmetic Actions",values:o.default.keys(this.arithmeticActions).map(function(t){return t+" "+e.arithmeticActions[t][0]+" "+e.arithmeticActions[t][1]}),background:"arith"}),r.push({name:"Regex Actions",values:o.default.keys(this.regexActions).map(function(t){return t+" ~= /"+e.regexActions[t][0]+"/"+e.regexActions[t][2]+"/"+e.regexActions[t][1]}),background:"regex"}),r.push({name:"Timing",values:o.default.keys(this.timing).map(function(t){return t+" : "+e.timing[t]}),background:"priority"});var i=o.default.toPairs(this.linkedNodes).filter(function(t){return/sink/.test(t[1])});return 0===i.length?r.push({name:"SINK ID: NULL",background:"link"}):1===i.length?r.push({name:"SINK ID: "+i[0][0],background:"link"}):i.length>1&&r.push({name:"SINK IDS:",values:i.map(function(t){return t[0]}),background:"link"}),r.push({name:"Priority: "+this.priority,background:"priority"}),r},e.Action=a},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Bookmark=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"bookmark",{},i),this.longName=t,this.url=[r]};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,s.prototype.getDescriptionObjects=function(){this.getDescriptionObjectsBase().push({name:"URL",values:this.url,background:"link"})},e.Bookmark=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Condition=void 0;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=n(0),s=r(o),a=n(1),u=n(2),c=["positive","negative","negConjCondition"],h=function(t,e,n,r,i){a.GraphNode.call(this,t,e,"condition",{},i),this.tags.conditionType="positive",this.constantTests=[],this.bindings={}};h.prototype=Object.create(a.GraphNode.prototype),h.constructor=h,h.prototype.setConditionType=function(t){if(c.indexOf(t)===-1)throw new Error("Unrecognised condition type");this.tags.conditionType=t},h.prototype.setTest=function(t,e,n,r){arguments<2?this.constantTests.splice(t,1):void 0!==t&&void 0!==this.constantTests[t]?this.constantTests[t]={field:e,operator:n,value:r}:this.constantTests.push({field:e,operator:n,value:r})},h.prototype.setBinding=function(t,e,n){arguments<2?delete this.bindings[t]:this.bindings[t]=[e,n]},h.prototype.getDescriptionObjects=function(){var t=this;if(this.minimised)return[{name:this.toString()+"...",background:"title"}];if("negConjCondition"===this.tags.conditionType){var e=[];return e.push({name:this.toString(),background:"title"}),e.push({name:"Conditions",values:s.default.toPairs(this.linkedNodes).filter(function(t){return/^condition/.test(t[1])}).map(function(t){return t.join(" : ")}),background:"link"}),e.push({name:"Tags",values:s.default.toPairs(this.tags).map(function(t){return t.join(" : ")}),background:"tags"}),e}var n=[];n.push({name:this.toString(),background:"title"}),n.push({name:"IF:",values:this.constantTests.map(function(t,e){return"("+e+"): wme.data."+t.field+" "+u.util.operatorToString(t.operator)+" "+t.value}),background:"test"}),n.push({name:"BIND:",values:s.default.keys(this.bindings).map(function(t){return/^[#\$]id/.test(t[0])?t+" <-- wme.id :: "+s.default.flatten(this.bindings[t][1]).join(" "):t+" <-- wme.data."+this.bindings[t][0]+" :: "+s.default.flatten(this.bindings[t][1]).join(" ")},this),background:"binding"});var r=s.default.toPairs(this.linkedNodes).filter(function(t){return/source/.test(t[1])});return 0===r.length?n.push({name:"SOURCE ID: NULL",background:"link"}):1===r.length?n.push({name:"SOURCE ID: "+r[0][0],background:"link"}):r.length>1&&n.push({name:"SOURCE IDS:",values:r.map(function(t){return t[0]}),background:"link"}),n.push({name:"Tags",values:s.default.keys(this.tags).map(function(e){return e+" : "+t.tags[e]}),background:"tags"}),n},h.prototype.getActiveLinks=function(t){void 0===t&&(t=["children","parents","conditions"]);var e=new Set;return t.forEach(function(t){"object"===i(this[t])&&s.default.keys(this[t]).forEach(function(t){return e.add(t)})},this),Array.from(e)},e.Condition=h},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Event=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"event",{},i)};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,e.Event=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.FSM=void 0;var i=n(0),o=r(i),s=n(1),a=function(t,e,n,r,i){s.GraphNode.call(this,t,e,"fsm",{},i),this.instanceStates={}};a.prototype=Object.create(s.GraphNode.prototype),a.constructor=a,a.prototype.getDescriptionObjects=function(){var t=this.getDescriptionObjectsBase();return t.push({name:"Currently Utilized By:",values:o.default.toPairs(this.positions).map(function(t){return t.join(" : ")})}),t},e.FSM=a},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Institution=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){var s=[{name:"roles",relType:"child",recType:"parent",subRelations:"incumbent challenger controlled exempt".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"activities",subRelations:"physical symbolic communicative unbound".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"IGU",relType:"child",recType:"parent"},{name:"FactGrammar",relType:"child",recType:"parent",subRelations:"physical symbolic communicative unbound".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"valueHierarchy",relType:"child",recType:"parent"},{name:"norms",relType:"child",recType:"parent",subRelations:"empiricallyExpected normativelyExpected sanctionable".split(" ").map(function(t){return{name:t,relType:"child",recType:"parent"}})},{name:"externalEffectors",relType:"child",recType:"parent"}];o.GraphNode.call(this,t,e,"institution",s,i)};s.constructor=s,s.prototype=Object.create(o.GraphNode.prototype),e.Institution=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Rule=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"rule",{},i)};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,e.Rule=s},function(t,e,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.State=void 0;var i=n(0),o=(r(i),n(1)),s=function(t,e,n,r,i){o.GraphNode.call(this,t,e,"state",{},i)};s.prototype=Object.create(o.GraphNode.prototype),s.constructor=s,e.State=s},function(t,e,n){var r,i,o;!function(n,s){i=[],r=s,o="function"==typeof r?r.apply(e,i):r,void 0!==o&&(t.exports=o)}(this,function(){"use strict";function t(e){if(!(this instanceof t))return new t(e);this._=e}function e(e){return e instanceof t}function n(t,e){return{status:!0,index:t,value:e,furthest:-1,expected:[]}}function r(t,e){return{status:!1,index:-1,value:null,furthest:t,expected:[e]}}function i(t,e){if(!e)return t;if(t.furthest>e.furthest)return t;var n=t.furthest===e.furthest?o(t.expected,e.expected):e.expected;return{status:t.status,index:t.index,value:t.value,furthest:e.furthest,expected:n}}function o(t,e){var n=t.length,r=e.length;if(0===n)return e;if(0===r)return t;for(var i={},o=0;o<n;o++)i[t[o]]=!0;for(var s=0;s<r;s++)i[e[s]]=!0;var a=[];for(var u in i)i.hasOwnProperty(u)&&a.push(u);return a.sort(),a}function s(t){if(!e(t))throw new Error("not a parser: "+t)}function a(t){if("number"!=typeof t)throw new Error("not a number: "+t)}function u(t){if(!(t instanceof RegExp))throw new Error("not a regexp: "+t);for(var e=b(t),n=0;n<e.length;n++){var r=e.charAt(n);if("i"!=r&&"m"!=r&&"u"!=r)throw new Error('unsupported regexp flag "'+r+'": '+t)}}function c(t){if("function"!=typeof t)throw new Error("not a function: "+t)}function h(t){if("string"!=typeof t)throw new Error("not a string: "+t)}function l(t){return 1===t.length?t[0]:"one of "+t.join(", ")}function f(t,e){var n=e.index,r=n.offset;if(r===t.length)return", got the end of the input";var i=r>0?"'...":"'",o=t.length-r>12?"...'":"'";return" at line "+n.line+" column "+n.column+", got "+i+t.slice(r,r+12)+o}function d(t,e){return"expected "+l(e.expected)+f(t,e)}function p(){for(var e=[].slice.call(arguments),r=e.length,o=0;o<r;o+=1)s(e[o]);return t(function(t,o){for(var s,a=new Array(r),u=0;u<r;u+=1){if(s=i(e[u]._(t,o),s),!s.status)return s;a[u]=s.value,o=s.index}return i(n(o,a),s)})}function g(){var t=[].slice.call(arguments);if(0===t.length)throw new Error("seqMap needs at least one argument");var e=t.pop();return c(e),p.apply(null,t).map(function(t){return e.apply(null,t)})}function y(e){return t(e(n,r))}function m(){var e=[].slice.call(arguments),n=e.length;if(0===n)return S("zero alternates");for(var r=0;r<n;r+=1)s(e[r]);return t(function(t,n){for(var r,o=0;o<e.length;o+=1)if(r=i(e[o]._(t,n),r),r.status)return r;return r})}function v(t,e){return w(t,e).or(E([]))}function w(t,e){s(t),s(e);var n=e.then(t).many();return t.chain(function(t){return n.map(function(e){return[t].concat(e)})})}function _(e){h(e);var i="'"+e+"'";return t(function(t,o){var s=o+e.length,a=t.slice(o,s);return a===e?n(s,a):r(o,i)})}function b(t){var e=""+t;return e.slice(e.lastIndexOf("/")+1)}function x(t){return RegExp("^(?:"+t.source+")",b(t))}function k(e,i){u(e),arguments.length>=2?a(i):i=0;var o=x(e),s=""+e;return t(function(t,e){var a=o.exec(t.slice(e));if(a){var u=a[0],c=a[i];if(null!=c)return n(e+u.length,c)}return r(e,s)})}function E(e){return t(function(t,r){return n(r,e)})}function S(e){return t(function(t,n){return r(n,e)})}function O(n){if(e(n))return t(function(t,e){var r=n._(t,e);return r.index=e,r.value="",r});if("string"==typeof n)return O(_(n));if(n instanceof RegExp)return O(k(n));throw new Error("not a string, regexp, or parser: "+n)}function N(e){return c(e),t(function(t,i){var o=t.charAt(i);return i<t.length&&e(o)?n(i+1,o):r(i,"a character matching "+e)})}function T(t){return N(function(e){return t.indexOf(e)>=0})}function A(t){return N(function(e){return t.indexOf(e)<0})}function M(e){return c(e),t(function(t,r){for(var i=r;i<t.length&&e(t.charAt(i));)i++;return n(i,t.slice(r,i))})}function j(e,n){arguments.length<2&&(n=e,e=void 0);var r=t(function(t,e){return r._=n()._,r._(t,e)});return e?r.desc(e):r}function I(t,e){var n=t.slice(0,e).split("\n");return{offset:e,line:n.length,column:n[n.length-1].length+1}}function R(){return S("fantasy-land/empty")}var C=t.prototype;C.parse=function(t){if("string"!=typeof t)throw new Error(".parse must be called with a string as its argument");var e=this.skip(B)._(t,0);return e.status?{status:!0,value:e.value}:{status:!1,index:I(t,e.furthest),expected:e.expected}},C.tryParse=function(t){var e=this.parse(t);if(e.status)return e.value;var n=d(t,e),r=new Error(n);throw r.type="ParsimmonError",r.result=e,r},C.or=function(t){return m(this,t)},C.then=function(t){if("function"==typeof t)throw new Error("chaining features of .then are no longer supported, use .chain instead");return s(t),p(this,t).map(function(t){return t[1]})},C.many=function(){var e=this;return t(function(t,r){for(var o=[],s=void 0;;){if(s=i(e._(t,r),s),!s.status)return i(n(r,o),s);r=s.index,o.push(s.value)}})},C.times=function(e,r){var o=this;return arguments.length<2&&(r=e),a(e),a(r),t(function(t,s){for(var a=[],u=void 0,c=void 0,h=0;h<e;h+=1){if(u=o._(t,s),c=i(u,c),!u.status)return c;s=u.index,a.push(u.value)}for(;h<r&&(u=o._(t,s),c=i(u,c),u.status);h+=1)s=u.index,a.push(u.value);return i(n(s,a),c)})},C.result=function(t){return this.map(function(){return t})},C.atMost=function(t){return this.times(0,t)},C.atLeast=function(t){return g(this.times(t),this.many(),function(t,e){return t.concat(e)})},C.map=function(e){c(e);var r=this;return t(function(t,o){var s=r._(t,o);return s.status?i(n(s.index,e(s.value)),s):s})},C["fantasy-land/map"]=C.map,C.skip=function(t){return p(this,t).map(function(t){return t[0]})},C.mark=function(){return g(U,this,U,function(t,e,n){return{start:t,value:e,end:n}})},C.lookahead=function(t){return this.skip(O(t))},C.desc=function(e){var n=this;return t(function(t,r){var i=n._(t,r);return i.status||(i.expected=[e]),i})},C.fallback=function(t){return this.or(E(t))};var P=t(function(t,e){return e>=t.length?r(e,"any character"):n(e+1,t.charAt(e))}),G=t(function(t,e){return n(t.length,t.slice(e))}),B=t(function(t,e){return e<t.length?r(e,"EOF"):n(e,null)}),U=t(function(t,e){return n(e,I(t,e))});C.concat=C.or,C["fantasy-land/concat"]=C.concat,C.empty=R,C["fantasy-land/empty"]=C.empty,C.of=E,C["fantasy-land/of"]=C.of,C.ap=function(t){return g(t,this,function(t,e){return t(e)})},C["fantasy-land/ap"]=C.ap,C.chain=function(e){var n=this;return t(function(t,r){var o=n._(t,r);return o.status?i(e(o.value)._(t,o.index),o):o})},C["fantasy-land/chain"]=C.chain;var D=k(/[0-9]/).desc("a digit"),L=k(/[0-9]*/).desc("optional digits"),q=k(/[a-z]/i).desc("a letter"),V=k(/[a-z]*/i).desc("optional letters"),F=k(/\s*/).desc("optional whitespace"),z=k(/\s+/).desc("whitespace");return t.all=G,t.alt=m,t.any=P,t.custom=y,t.digit=D,t.digits=L,t.eof=B,t.fail=S,t.formatError=d,t.index=U,t.isParser=e,t.lazy=j,t.letter=q,t.letters=V,t.lookahead=O,t.makeFailure=r,t.makeSuccess=n,t.noneOf=A,t.oneOf=T,t.optWhitespace=F,t.Parser=t,t.regex=k,t.regexp=k,t.sepBy=v,t.sepBy1=w,t.seq=p,t.seqMap=g,t.string=_,t.succeed=E,t.takeWhile=M,t.test=N,t.whitespace=z,t.empty=R,t["fantasy-land/empty"]=R,t.of=E,t["fantasy-land/of"]=E,t})},function(t,e,n){"use strict";function r(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}function i(t){return t&&t.__esModule?t:{default:t}}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0}),e.Shell=void 0;var s=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},u=n(0),c=i(u),h=n(6),l=n(1),f=n(4),d=(n(2),n(5)),p=n(3),g=r(p),y=function t(e){o(this,t),this._root=new l.GraphNode("_root",-1),this._nodes=new Map,this.set(this._root),this._ruleIds=[],this._cwd=this._root,this._nodeStash=[],this._previousLocation=[this._root.id],this._searchResults=[],this._reteNet=new h.ReteNet(e),this._reteNetBackupActions=e,this._reteOutput=[],this._simulation=null,this._parser=d.parser};y.prototype.parse=function(t){var e=this._parser.parse(t);return e.status===!1?(console.log("Bad Parse:",e),null):(e=e.value,this.actOnParse(e))},y.prototype.actOnParse=function(t){var e=this;switch(t.constructor){case g.Cd:this.cdByString(t.id);break;case g.Rm:t.ids.forEach(function(t){e.rm(t)});break;case g.Mk:t.names.forEach(function(t){e.addNode(t)});break;case g.Link:this.link(t.destId,"child","parent",t.sourceId);break;case g.SetTag:t.tagNames.forEach(function(t){return e.cwd().tagToggle(t)});break;case g.SetValue:this.cwd().setValue(t.valName,t.value);break;case g.Search:this.search(t.type,t.variable,t.value);break;case g.Refine:this.refine(t.type,t.variable,t.value);break;case g.Apply:this.actOnSearchResults(t);break;case g.Import:this.import(t.text);break;case g.Unparameterised:return this.processUnparameterisedCommand(t);default:throw new Error("Unrecognised command parsed")}return null},y.prototype.actOnSearchResults=function(t){var e=this,n=this.searchResults(),r=this.cwd().id;if(!(t instanceof g.Apply))throw new Error("Instructed to apply, without passing a CStructs.Apply");if(0===n.length)throw new Error("Instructed to act on empty search results");n.forEach(function(n){e.cdById(n),e.actOnParse(t.command)}),this.cdById(r)},y.prototype.processUnparameterisedCommand=function(t){switch(t.name){case"export":return this.export();case"stash":this.stash();break;case"unstash":this.unstash();break;case"root":this.cdById(this._root.id);break;case"cwd":return this.printState();case"help":return this.help();case"prior":this.cdById(this.prior());break;case"clear":this._searchResults=[];break;case"select":this._searchResults.push(this.cwd().id);break;default:throw new Error("Unrecognised Unparameterised Command: "+t.name)}return null},y.prototype.getCtor=f.getCtor,y.prototype.length=function(){return this._nodes.size},y.prototype.numRules=function(){return this._ruleIds.length},y.prototype.has=function(t){return t instanceof l.GraphNode&&(t=t.id),this._nodes.has(t)},y.prototype.get=function(t){if(this.has(Number(t)))return this._nodes.get(Number(t));throw new Error("Node "+t+" does not exist")},y.prototype.set=function(t){if(!(t instanceof l.GraphNode))throw new Error("Cannot add a non-GraphNode");if(this.has(t.id))throw console.log(this._nodes),new Error("Cannot replace already existing nodes: "+t.id);this._nodes.set(t.id,t)},y.prototype.rm=function(t){if(t instanceof l.GraphNode&&(t=t.id),!this.has(t))throw new Error("Can't remove a node that doesn't exist");var e=!0,n=!1,r=void 0;try{for(var i,o=this.get(t)._edges.keys()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;this.get(s).removeEdge(t)}}catch(t){n=!0,r=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw r}}this._nodes.delete(t)},y.prototype.root=function(){return this._root},y.prototype.cwd=function(){return this._cwd},y.prototype.prior=function(){return c.default.last(this._previousLocation)},y.prototype.searchResults=function(){return Array.from(this._searchResults)},y.prototype.reteOutput=function(){return Array.from(this._reteOutput)},y.prototype.link=function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,i=r?this.get(r):this.cwd(),o=this.get(t);i.setEdge(o.id,{id:i.id,relation:n},{},{id:o.id,relation:e}),o.setEdge(i.id,{id:i.id,relation:n},{},{id:o.id,relation:e})},y.prototype.addNode=function(t,e,n,r,i){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0,s=o?this.get(o):this.cwd();null!==t&&void 0!==t&&""!==t||(t=n||"anon"),n=n||"parent",e=e||"child",r=r||"graphnode";var a=(0,f.getCtor)(r),u=new a(t,s.id);return this.set(u),this.link(u.id,e,n,s.id),u.id},y.prototype.deleteNode=function(t){this.rm(t)},y.prototype.cdByString=function(t){if(!Number.isNaN(Number(t)))return void this.cdById(Number(t));if(null===t.match(/\.\./))throw new Error("Unimplemented: "+t);this.cdById(this.cwd().getValue("_parentId"))},y.prototype.cdById=function(t){if("number"!=typeof t)throw new Error("Cd'ing needs an id, instead got "+(void 0===t?"undefined":a(t)));if(!this.has(t))throw new Error("Can't cd to a non-existent node");this._previousLocation.push(this.cwd().id),this._cwd=this.get(t)},y.prototype.stash=function(){this._nodeStash.push(this.cwd().id)},y.prototype.unstash=function(){return this._nodeStash.pop()},y.prototype.getStash=function(){return c.default.clone(this._nodeStash)},y.prototype.export=function(){var t=[],e=!0,n=!1,r=void 0;try{for(var i,o=this._nodes.values()[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var s=i.value;t.push(s.toJSONCompatibleObj())}}catch(t){n=!0,r=t}finally{try{!e&&o.return&&o.return()}finally{if(n)throw r}}return{description:"json",text:JSON.stringify({nodes:t,root:this._root.id})}},y.prototype.import=function(t){var e=JSON.parse(t);console.log("Loading data:",e),this._nodes.clear();var n=!0,r=!1,i=void 0;try{for(var o,s=e.nodes[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value,u=l.GraphNode.fromJSON(a);this.set(u)}}catch(t){r=!0,i=t}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}this._root=this._nodes.get(e.root),this._cwd=this._root},y.prototype.search=function(t,e,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=[];switch(o=i?this._searchResults.map(function(t){return r.get(t)}):Array.from(this._nodes.values()),t){case"name":if(null!==n||!(e instanceof RegExp))throw new Error("Incorrect Name Search");var a=o.filter(function(t){return e.test(t.name())});this._searchResults=a.map(function(t){return t.id});break;case"tag":if(null!==n||!(e instanceof RegExp))throw new Error("Incorrect Tag Search");console.log("Searching for a tag:");var u=o.map(function(t){return[t.id,t.tags()]}),h=u.filter(function(t){var n=s(t,2),r=(n[0],n[1]);return c.default.some(r,function(t){return e.test(t)})}),l=h.map(function(t){var e=s(t,2),n=e[0];e[1];return n});this._searchResults=l;break;case"value":if(!(null!==n&&e instanceof RegExp&&n instanceof RegExp))throw new Error("Incorrect Value Search");var f=o.filter(function(t){return c.default.some(t.values(),function(t){var r=s(t,2),i=r[0],o=r[1];return e.test(i)&&n.test(o)})});this._searchResults=f.map(function(t){return t.id});break;case"edge":if(null===n||!/dest|source/.test(e))throw new Error("Incorrect Edge Search");var d=o.filter(function(t){return t.hasEdgeWith(n)&&t.getEdgeTo(n).idMatches(n,e)});this._searchResults=d.map(function(t){return t.id});break;default:throw new Error("Incorrect Search Specified")}},y.prototype.refine=function(t,e,n){return this.search(t,e,n,!0)},y.prototype.dfs=function(){throw new Error("Unimplemented: DFS")},y.prototype.bfs=function(){throw new Error("Unimplemented: BFS")},y.prototype.help=function(){throw new Error("Unimplemented: Help")},y.prototype.getPath=function(){for(var t=[],e=this.cwd();e.id!==this._root.id&&e.getValue("_parentId")!==e.id;)t.unshift([e.name(),e.id]),e=this.get(e.getValue("_parentId"));return t.unshift([this._root.name(),this._root.id]),t},y.prototype.printState=function(){var t=this.cwd();return{description:"stateDescription",inputs:t.getParents(),node:t,outputs:t.getChildren(),searchResults:c.default.clone(this._searchResults),currentPath:this.getPath(),stash:this.getStash()}},e.Shell=y}])});